---
alwaysApply: true
---

# Reglas del Proyecto Brisca Multiplatform

Este documento contiene todas las reglas, convenciones y lineamientos que DEBEN seguirse estrictamente en el proyecto Brisca Multiplatform.

## ğŸš¨ REGLA FUNDAMENTAL: NUNCA TOCAR MAIN DIRECTAMENTE

**ANTES de hacer cualquier cambio en el cÃ³digo:**
1. âœ… Crear una rama segÃºn el tipo de cambio (feat/, fix/, etc.)
2. âœ… Leer las reglas de Git en `docs/git-workflow.md`
3. âœ… Seguir el flujo de trabajo establecido
4. âŒ NUNCA hacer commits directos a `main`
5. âŒ NUNCA modificar cÃ³digo sin crear una rama primero

---

## ğŸ“‹ FLUJO DE TRABAJO GIT

### Tipos de Ramas (OBLIGATORIO)

| Tipo | Prefijo | DescripciÃ³n | Ejemplo |
|------|---------|-------------|---------|
| Feature | `feat/` | Nuevas caracterÃ­sticas | `feat/fix-firebase-analytics-ios` |
| Fix | `fix/` | CorrecciÃ³n de errores | `fix/login-crash` |
| Documentation | `docs/` | Cambios en documentaciÃ³n | `docs/api-reference` |
| Style | `style/` | Formato, espacios, etc. | `style/lint-fixes` |
| Refactor | `refactor/` | Mejoras sin cambios funcionales | `refactor/authentication-flow` |
| Test | `test/` | AÃ±adir o corregir pruebas | `test/login-integration` |
| Chore | `chore/` | Build o herramientas | `chore/gradle-update` |
| Hotfix | `hotfix/` | Correcciones urgentes | `hotfix/security-vulnerability` |

### Proceso de Trabajo

1. **Crear rama desde main:**
   ```bash
   git checkout main
   git pull origin main
   git checkout -b fix/firebase-analytics-ios main
   ```

2. **Desarrollar en la rama:**
   - Hacer cambios
   - Commits siguiendo convenciones
   - Push a remoto: `git push -u origin fix/firebase-analytics-ios`

3. **Crear Pull Request hacia main:**
   - Usar plantilla de PR
   - Asignar revisores
   - Esperar aprobaciÃ³n

4. **Merge a main:**
   - Solo despuÃ©s de revisiÃ³n y aprobaciÃ³n
   - Usar "Squash and merge"

### Convenciones de Commits (OBLIGATORIO)

**Formato estricto:**
```
<tipo>(<scope>): <descripciÃ³n breve en minÃºsculas>

<cuerpo detallado con bullets opcionales>

[referencia PR]
```

**Reglas:**
- Tipo siempre en **minÃºsculas**: `feat`, `fix`, `docs`, etc.
- Scope para historias tÃ©cnicas: `ht-XX` (ej: `ht-09`)
- Scope para features: `auth`, `notif`, `ui`, `nav`, etc.
- DescripciÃ³n: Primera palabra en minÃºsculas, mÃ¡ximo 50 caracteres
- Siempre incluir `(#nÃºmero)` al final del tÃ­tulo o cuerpo

**Ejemplos correctos:**
```bash
fix(analytics): resolve firebase user properties errors in ios

- Filter user_id from user properties (reserved name)
- Truncate user_email to 36 characters max
- Improve error handling to prevent app freezing

(#XX)

feat(ht-09): developer panel with FCM topics

- DeveloperPanelScreen centralizado con 9 herramientas
- TopicSubscriptionScreen para gestiÃ³n de topics FCM
- Sistema de navegaciÃ³n URI-based: brisca://developer-panel

(#13)
```

**Ejemplos incorrectos (NO USAR):**
```bash
âŒ Feat/ht 08 token renewal
âŒ Feature/ht-04 smart login implementation
âŒ feat(HT-17-NOTIF): implementar Koin DI
âŒ feat(auth): Implement Firebase Authentication  # Capitalizada
âŒ fix(analytics): resolve firebase errors  # Sin PR reference
```

---

## ğŸ—ï¸ ARQUITECTURA TÃCTICA

### Stack TecnolÃ³gico

- **NavegaciÃ³n**: Decompose (componentes con ciclo de vida)
- **Arquitectura**: Clean Architecture + Domain Driven Design (DDD)
- **Red**: Ktor Client 3.1.3 (HttpClient multiplataforma)
- **DI**: Koin 4.0.4
- **UI**: Compose Multiplatform
- **Sistema de DiseÃ±o**: Dui (Design UI Components)

### Decompose - Componentes

**Principios:**
- Cada feature/flujo es un **Component** independiente
- Componentes tienen ciclo de vida propio
- NavegaciÃ³n type-safe con sealed classes
- IntegraciÃ³n natural con Clean Architecture

**Estructura de Component:**
```kotlin
class LoginComponent(
    componentContext: ComponentContext,
    private val login: Login,  // Use case
    private val navigator: Navigator
) : ComponentContext by componentContext {
    
    private val state = MutableValue(LoginState())
    val stateValue: Value<LoginState> = state
    
    fun onIntent(intent: LoginIntent) {
        // Procesar intents
    }
}
```

**NavegaciÃ³n:**
```kotlin
sealed class RootChild {
    object Splash : RootChild()
    object Login : RootChild()
    data class Home(val tab: HomeTab) : RootChild()
}

val navigation = StackNavigation<RootChild>()
val childStack = childStack(
    source = navigation,
    initialConfiguration = RootChild.Splash
) { child, ctx ->
    when (child) {
        is RootChild.Splash -> SplashComponent(ctx)
        is RootChild.Login -> LoginComponent(ctx, login, navigator)
        is RootChild.Home -> HomeComponent(ctx, child.tab)
    }
}
```

### Clean Architecture + DDD

**Estructura por Feature:**
```
features/auth/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entity/          # Entidades con identidad y comportamiento
â”‚   â”œâ”€â”€ valueobject/     # Value objects inmutables
â”‚   â”œâ”€â”€ repository/      # Interfaces de repositorios
â”‚   â””â”€â”€ usecase/         # Casos de uso (SIN sufijo "UseCase")
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ model/           # DTOs para transferencia
â”‚   â”œâ”€â”€ source/          # Fuentes de datos (remote/local)
â”‚   â”œâ”€â”€ repository/      # Implementaciones de repositorios
â”‚   â””â”€â”€ mapper/          # Mappers entre entidades y DTOs
â””â”€â”€ presentation/
    â”œâ”€â”€ component/       # Componentes Decompose
    â””â”€â”€ compose/         # Pantallas Compose
```

**Reglas de Dependencia:**
- âœ… Domain NO depende de Data ni Presentation
- âœ… Presentation depende de Domain
- âœ… Data depende de Domain
- âŒ Features NO dependen entre sÃ­ (usar `commons/` para compartir)

**Casos de Uso:**
- Nombres SIN sufijo "UseCase": `Login`, `GetNews`, `SendScreenInAnalytics`
- Encapsulan lÃ³gica de negocio
- Reciben repositorios por inyecciÃ³n
- Retornan `Result<T>` o tipos especÃ­ficos del dominio

**Ejemplo:**
```kotlin
class Login(
    private val authRepository: AuthRepository
) {
    suspend operator fun invoke(
        credentials: Credentials
    ): Result<User> {
        // ValidaciÃ³n y lÃ³gica de negocio
        return authRepository.login(credentials)
    }
}
```

### Ktor - Infraestructura de Red

**HttpClient:**
- Usar `IpchileHttpClient` para requests
- ConfiguraciÃ³n automÃ¡tica de headers (APP-KEY, Content-Type, User-Agent)
- Manejo estandarizado de errores
- Timeouts por entorno (DEV: 5s, STAGING: 15s, PROD: 30s)

**Uso en Repositories:**
```kotlin
class NewsRepositoryImpl(
    private val httpClient: HttpClient
) : NewsRepository {
    override suspend fun getNews(): List<News> {
        val url = NetworkConfig.buildUrl(ApiEndpoints.NEWS_LIST)
        return httpClient.get(url).body()
    }
}
```

**Manejo de Errores:**
```kotlin
try {
    val response = httpClient.get(url)
} catch (e: NetworkException.Unauthorized) {
    // Error 401
} catch (e: NetworkException.ValidationError) {
    // Error 422
} catch (e: NetworkException.ServerError) {
    // Error 500
} catch (e: NetworkException.NetworkError) {
    // Error de red
}
```

---

## ğŸ¨ SISTEMA DE DISEÃ‘O Dui

### Principios Dui

1. **ReutilizaciÃ³n Total**: Un componente para todos los casos
2. **ConfiguraciÃ³n Simple**: Solo parÃ¡metros esenciales
3. **Sin Textos Hardcodeados**: Todos los textos desde interfaces de strings
4. **Consistencia AutomÃ¡tica**: Mismo patrÃ³n de diseÃ±o
5. **ComposiciÃ³n Interna**: Dui usa Dui internamente, NO Material 3 directamente

### Estructura Dui

**Atomic Design:**
- **Atoms**: `DuiButton`, `DuiText`, `DuiIcon`
- **Molecules**: `DuiTextField`, `DuiCard`, `DuiToolbar`
- **Organisms**: `DuiErrorScreen`, `DuiBottomNavigationBar`

**UbicaciÃ³n:**
```
core/ui/design/chameleon/
â”œâ”€â”€ atoms/        # Componentes bÃ¡sicos
â”œâ”€â”€ molecules/    # Componentes compuestos
â””â”€â”€ organisms/    # Componentes complejos
```

### Reglas de Uso Dui

**âœ… CORRECTO - ComposiciÃ³n Interna:**
```kotlin
@Composable
fun DuiSnackbar(
    message: String,
    actionLabel: String? = null
) {
    Snackbar(
        action = actionLabel?.let { label ->
            {
                DuiTextButton(
                    text = label,
                    onClick = { /* ... */ }
                )
            }
        }
    ) {
        DuiBodyText(text = message)
    }
}
```

**âŒ INCORRECTO - Uso Directo de Material 3:**
```kotlin
@Composable
fun DuiSnackbar(message: String) {
    Snackbar {
        Text(message)  // âŒ NO usar Text directamente
    }
}
```

### Dimensiones

**Usar ThemeDimens global:**
```kotlin
// âœ… CORRECTO
DuiSpacer(size = ThemeDimens.NORMAL_SPACING)
padding = ThemeDimens.NORMAL_SPACING

// âŒ INCORRECTO
DuiSpacer(size = 16.dp)
padding = 16.dp
```

### Colores

**Usar MaterialTheme.colorScheme:**
```kotlin
// âœ… CORRECTO
color = MaterialTheme.colorScheme.primary
backgroundColor = MaterialTheme.colorScheme.surface

// âŒ INCORRECTO
color = ThemeColors.primary
backgroundColor = Color(0xFF123456)
```

---

## ğŸŒ INTERNACIONALIZACIÃ“N (OBLIGATORIO)

### Reglas Estrictas

1. **TODOS los textos visibles en UI DEBEN usar interfaces de strings**
2. **NUNCA hardcodear strings en UI**
3. **Seguir ADR-0019: Interfaces segregadas por pantalla**

### Estructura de Strings

**Interfaces por pantalla:**
```kotlin
interface LoginStrings {
    val title: String
    val emailLabel: String
    val passwordLabel: String
    val loginButton: String
    val forgotPasswordButton: String
}

interface HomeStrings {
    val welcomeMessage: String
    val newsTitle: String
    // ...
}
```

**Uso en Componentes:**
```kotlin
@Composable
fun LoginScreen(
    strings: LoginStrings,
    onLoginClick: () -> Unit
) {
    DuiTitleText(text = strings.title)
    DuiTextField(
        label = strings.emailLabel,
        // ...
    )
    DuiButton(
        text = strings.loginButton,
        onClick = onLoginClick
    )
}
```

**âŒ NUNCA hacer esto:**
```kotlin
// âŒ INCORRECTO
Text("Iniciar SesiÃ³n")
Button(onClick = {}) {
    Text("Ingresar")
}

// âœ… CORRECTO
DuiTitleText(text = loginStrings.title)
DuiButton(
    text = loginStrings.loginButton,
    onClick = onLoginClick
)
```

---

## ğŸ“ CONVENCIONES DE CÃ“DIGO

### Nomenclatura

- **Archivos y Clases**: PascalCase (`LoginComponent.kt`, `AuthRepository`)
- **Funciones y Variables**: camelCase (`getUserData()`, `isLoading`)
- **Constantes**: SNAKE_CASE (`MAX_RETRY_COUNT`, `API_BASE_URL`)
- **Paquetes**: minÃºsculas con puntos (`cl.silverbullet.multiplatform.brisca.features.auth`)

### Comentarios (PROHIBIDOS)

**âŒ NUNCA usar comentarios `//` que expliquen cÃ³digo obvio:**
- âŒ `// Validamos el usuario`
- âŒ `// Llamamos a la API`
- âŒ `// Retornamos el resultado`
- âŒ Cualquier comentario que describa lo que el cÃ³digo hace de forma obvia

**âœ… SOLO usar Javadoc/KDoc cuando sea necesario:**
- Funciones pÃºblicas
- Clases pÃºblicas
- Propiedades pÃºblicas complejas
- LÃ³gica de negocio no obvia
- Decisiones de diseÃ±o importantes

**Ejemplo:**
```kotlin
/**
 * Valida las credenciales del usuario y genera un token de autenticaciÃ³n.
 *
 * @param username Nombre de usuario
 * @param password ContraseÃ±a del usuario
 * @return Token de autenticaciÃ³n si las credenciales son vÃ¡lidas
 */
fun authenticate(username: String, password: String): String?
```

### Strings Hardcodeados (PROHIBIDOS)

**âŒ NUNCA usar strings hardcodeados en:**
- Textos visibles al usuario
- Mensajes de error mostrados al usuario
- Textos de botones
- TÃ­tulos, subtÃ­tulos, descripciones
- Placeholders de inputs
- Content descriptions de accesibilidad

**âœ… SIEMPRE usar interfaces de strings:**
- Cada pantalla/feature tiene su propia interfaz de strings
- Implementaciones por idioma
- InyecciÃ³n en componentes

**Excepciones MUY LIMITADAS:**
- Logs de debugging (`Log.d("TAG", "debug message")`)
- Nombres de constantes tÃ©cnicas (`const val API_KEY = "key123"`)
- Regex patterns (`Regex("pattern")`)

### Casos de Uso

- **SIN sufijo "UseCase"**: `Login`, `GetNews`, `SendScreenInAnalytics`
- **Con operador invoke**: `login(credentials)`
- **Retornan Result o tipos del dominio**

### SeparaciÃ³n de Efectos

**Efectos de NavegaciÃ³n:**
- Manejar fuera del composable principal
- En un handler de navegaciÃ³n separado

**Efectos de Mensajes UI:**
- Pueden manejarse dentro del composable
- Snackbars, toasts, diÃ¡logos, banners

**Ejemplo:**
```kotlin
// ViewModel
private val _navigationEffects = MutableSharedFlow<NavigationEffect>()
val navigationEffects: SharedFlow<NavigationEffect> = _navigationEffects

private val _uiEffects = MutableSharedFlow<UiEffect>()
val uiEffects: SharedFlow<UiEffect> = _uiEffects

// En el entrypoint de la pantalla
@Composable
fun ExampleScreenEntryPoint(
    viewModel: ExampleViewModel,
    navigator: Navigator
) {
    val state by viewModel.state.collectAsState()

    // Handler de navegaciÃ³n (fuera del composable principal)
    LaunchedEffect(Unit) {
        viewModel.navigationEffects.collect { effect ->
            when (effect) {
                is NavigationEffect.NavigateTo -> navigator.navigate(effect.uri)
                NavigationEffect.CloseScreen -> navigator.close()
            }
        }
    }

    // Handler de efectos de UI (puede estar en el composable)
    LaunchedEffect(Unit) {
        viewModel.uiEffects.collect { effect ->
            when (effect) {
                is UiEffect.ShowSnackbar -> { /* Mostrar snackbar */ }
            }
        }
    }

    ExampleScreen(state = state, onIntent = viewModel::onIntent)
}
```

---

## ğŸ§ª TESTING

### Estrategia

- **Casos de uso testables**: LÃ³gica de negocio en casos de uso
- **UI sin lÃ³gica de negocio**: Componentes solo presentaciÃ³n
- **Mocks para repositorios**: Usar implementaciones en memoria

### Estructura de Tests

```
commonTest/
â””â”€â”€ features/
    â””â”€â”€ auth/
        â””â”€â”€ domain/
            â””â”€â”€ usecase/
                â””â”€â”€ LoginTest.kt
```

---

## ğŸ“ ESTRUCTURA DEL PROYECTO

### OrganizaciÃ³n

```
composeApp/src/commonMain/kotlin/cl/silverbullet/multiplatform/brisca/
â”œâ”€â”€ core/                    # Componentes base
â”‚   â”œâ”€â”€ platform/           # Abstracciones de plataforma
â”‚   â”œâ”€â”€ di/                 # ConfiguraciÃ³n DI (Koin)
â”‚   â”œâ”€â”€ network/            # Ktor HttpClient
â”‚   â”œâ”€â”€ storage/            # Almacenamiento local
â”‚   â”œâ”€â”€ utils/              # Utilities compartidas
â”‚   â””â”€â”€ ui/                 # Dui y themes
â”œâ”€â”€ commons/                # Elementos compartidos entre features
â”‚   â”œâ”€â”€ domain/            # Entidades, casos de uso compartidos
â”‚   â”œâ”€â”€ data/              # Implementaciones compartidas
â”‚   â””â”€â”€ presentation/      # ViewModels/Estados compartidos
â””â”€â”€ features/              # Features por funcionalidad
    â”œâ”€â”€ auth/
    â”‚   â”œâ”€â”€ domain/        # Entidades, value objects, repositorios, casos de uso
    â”‚   â”œâ”€â”€ data/          # DTOs, fuentes de datos, implementaciones
    â”‚   â””â”€â”€ presentation/   # Componentes Decompose, Compose
    â”œâ”€â”€ notifications/
    â””â”€â”€ ...
```

### Reglas de Dependencia

- âœ… Domain NO depende de Data ni Presentation
- âœ… Presentation depende de Domain
- âœ… Data depende de Domain
- âŒ Features NO dependen entre sÃ­ (usar `commons/`)

---

## ğŸ”§ INYECCIÃ“N DE DEPENDENCIAS (Koin)

### MÃ³dulos

- **CoreModule**: ConfiguraciÃ³n base
- **NetworkModule**: HttpClient y configuraciÃ³n de red
- **AnalyticsModule**: Firebase Analytics y Crashlytics
- **Feature Modules**: MÃ³dulos por feature

### Estrategia de Sharing

- **Repositories**: `single` (una instancia compartida)
- **Use Cases**: `factory` (nueva instancia cada vez)
- **Components**: Inyectados en el constructor

**Ejemplo:**
```kotlin
val analyticsModule = module {
    single<AnalyticsProvider> {
        CompositeAnalyticsProvider(providers = listOf(...))
    }
    factory { SetUserPropertiesInAnalytics(analyticsProvider = get()) }
}
```

---

## âš ï¸ ERRORES COMUNES A EVITAR

### âŒ NO hacer:

1. **Commits directos a main**
2. **Hardcodear strings en UI**
3. **Usar Material 3 directamente en lugar de Dui**
4. **Hardcodear dimensiones (usar ThemeDimens)**
5. **Hardcodear colores (usar MaterialTheme.colorScheme)**
6. **Crear casos de uso con sufijo "UseCase"**
7. **Hacer que features dependan entre sÃ­**
8. **Mezclar lÃ³gica de negocio en UI**
9. **Usar nombres de user properties reservados de Firebase** (`user_id` es reservado)
10. **No validar lÃ­mites de Firebase Analytics** (36 caracteres para user properties)
11. **Implementar cÃ³digo sin diseÃ±o detallado aprobado**

### âœ… SIEMPRE hacer:

1. **Crear rama antes de modificar cÃ³digo**
2. **Usar interfaces de strings para todos los textos**
3. **Usar componentes Dui**
4. **Usar ThemeDimens para dimensiones**
5. **Usar MaterialTheme.colorScheme para colores**
6. **Nombrar casos de uso sin sufijo "UseCase"**
7. **Separar efectos de navegaciÃ³n y UI**
8. **Validar propiedades de Firebase antes de enviarlas**
9. **Manejar errores de red correctamente**
10. **Seguir convenciones de commits**
11. **Completar diseÃ±o detallado antes de implementar**

---

## ğŸ“š DOCUMENTACIÃ“N DE REFERENCIA

### Documentos Importantes

- **Git Workflow**: `docs/git-workflow.md`
- **Decompose Architecture**: `docs/development/decompose-architecture.md`
- **Ktor Infrastructure**: `docs/technical/ktor-infrastructure-guide.md`
- **Dui Design System**: `docs/architecture/decisions/0028-dui-design.md`
- **Project Structure**: `docs/architecture/project-structure.md`

### ADRs (Architecture Decision Records)

- ADR-0019: Interfaces de strings segregadas por pantalla
- ADR-0028: Sistema de DiseÃ±o Dui
- ADR-0030: Sistema de Colores Material 3

---

## ğŸ¯ CHECKLIST ANTES DE HACER CAMBIOS

Antes de modificar cualquier cÃ³digo, verificar:

- [ ] Â¿CreÃ© una rama segÃºn el tipo de cambio?
- [ ] Â¿LeÃ­ las reglas de Git workflow?
- [ ] Â¿SeguirÃ© las convenciones de commits?
- [ ] Â¿UsarÃ© componentes Dui en lugar de Material 3 directo?
- [ ] Â¿UsarÃ© interfaces de strings para todos los textos?
- [ ] Â¿UsarÃ© ThemeDimens para dimensiones?
- [ ] Â¿UsarÃ© MaterialTheme.colorScheme para colores?
- [ ] Â¿El caso de uso no tiene sufijo "UseCase"?
- [ ] Â¿ValidÃ© las dependencias entre capas?
- [ ] Â¿ManejÃ© correctamente los errores de red?
- [ ] Â¿Existe diseÃ±o detallado aprobado para este cambio?

---

**Ãšltima actualizaciÃ³n**: 2024-11-26
**VersiÃ³n**: 1.0.0
